# üöÄ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker (—á—Ç–æ–±—ã –Ω–µ –Ω—É–∂–µ–Ω –±—ã–ª sudo)
sudo usermod -aG docker $USER

# –ü–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
exit
# –ó–∞–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞ –ø–æ SSH
```

### 2. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
cd ~
git clone https://github.com/a-afanasyev/Infrasafe_bot.git
cd Infrasafe_bot
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env —Ñ–∞–π–ª–∞

```bash
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä
cp .env.unified.example .env

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª
nano .env
```

### 4. ‚ö†Ô∏è –í–ê–ñ–ù–û: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DATABASE_URL —Å –ø–∞—Ä–æ–ª–µ–º —Å–æ–¥–µ—Ä–∂–∞—â–∏–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ –≤–∞—à –ø–∞—Ä–æ–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç `@`, `$`, `#`, `:` –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã, Docker Compose –º–æ–∂–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –µ–≥–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å.

**–†–µ—à–µ–Ω–∏–µ 1: URL-encoding –ø–∞—Ä–æ–ª–µ–π**

–ï—Å–ª–∏ –ø–∞—Ä–æ–ª—å `Inf@$afe`, –∑–∞–∫–æ–¥–∏—Ä—É–π—Ç–µ –µ–≥–æ:
- `@` ‚Üí `%40`
- `$` ‚Üí `%24`
- `#` ‚Üí `%23`
- `:` ‚Üí `%3A`
- `/` ‚Üí `%2F`

```bash
# –ü—Ä–∏–º–µ—Ä: –ø–∞—Ä–æ–ª—å Inf@$afe —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è Inf%40%24afe
DATABASE_URL=postgresql://uk_bot:Inf%40%24afe@postgres:5432/uk_management
```

**–†–µ—à–µ–Ω–∏–µ 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–∞—Ä–æ–ª—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –Ω–∞—á–∞–ª–∞)**

```bash
# .env —Ñ–∞–π–ª
POSTGRES_PASSWORD=MySecurePassword123

# DATABASE_URL –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ –ø–∞—Ä–æ–ª—å
DATABASE_URL=postgresql://uk_bot:MySecurePassword123@postgres:5432/uk_management
```

### 5. –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ .env —Ñ–∞–π–ª–∞

```bash
# ==================== –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ ====================
# –¢–æ–∫–µ–Ω –æ—Å–Ω–æ–≤–Ω–æ–≥–æ UK Management –±–æ—Ç–∞
BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz

# –¢–æ–∫–µ–Ω Media Service –±–æ—Ç–∞ (–æ—Ç–¥–µ–ª—å–Ω—ã–π –±–æ—Ç!)
MEDIA_BOT_TOKEN=9876543210:ZYXwvuTSRqponMLKjihGFEdcba

# ==================== DATABASE ====================
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø–∞—Ä–æ–ª—å –≤ –æ–±–æ–∏—Ö –º–µ—Å—Ç–∞—Ö!
POSTGRES_PASSWORD=MySecurePassword123
DATABASE_URL=postgresql://uk_bot:MySecurePassword123@postgres:5432/uk_management

# Database settings
POSTGRES_DB=uk_management
POSTGRES_USER=uk_bot

# ==================== REDIS ====================
REDIS_URL=redis://redis:6379/0
MEDIA_REDIS_URL=redis://redis:6379/1
USE_REDIS_RATE_LIMIT=true

# ==================== MEDIA CHANNELS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ====================
# ID Telegram –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–¥–∏–∞
# –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã, –∏–∑–º–µ–Ω—è–π—Ç–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω—ã —Å–≤–æ–∏ –∫–∞–Ω–∞–ª—ã
CHANNEL_REQUESTS=-1003091883002
CHANNEL_REPORTS=-1002969942316
CHANNEL_ARCHIVE=-1002725515580
CHANNEL_BACKUP=-1002951349061

# ==================== –û–°–¢–ê–õ–¨–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ ====================
LOG_LEVEL=INFO
DEBUG=false
```

### 6. –ó–∞–ø—É—Å–∫

```bash
# –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ (–±–µ–∑ sudo –µ—Å–ª–∏ –≤—ã –≤ –≥—Ä—É–ø–ø–µ docker)
make start

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
make logs

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
make ps

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
make health
```

### 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
docker ps

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω—ã:
# - uk-bot
# - uk-media-service
# - uk-media-frontend
# - uk-postgres
# - uk-redis

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞
docker logs uk-bot

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å healthcheck
curl http://localhost:8009/api/v1/health
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞: "telegram_bot_token Field required"

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω MEDIA_BOT_TOKEN –¥–ª—è Media Service.

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –í .env —Ñ–∞–π–ª–µ –¥–æ–±–∞–≤—å—Ç–µ:
MEDIA_BOT_TOKEN=your_media_bot_token_here
```

**–í–∞–∂–Ω–æ**: –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å **–¥–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –±–æ—Ç–∞**:
1. UK Management Bot - –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç (BOT_TOKEN)
2. Media Service Bot - –±–æ—Ç –¥–ª—è –º–µ–¥–∏–∞ (MEDIA_BOT_TOKEN)

–û–±–∞ —Ç–æ–∫–µ–Ω–∞ –ø–æ–ª—É—á–∏—Ç–µ —É @BotFather –≤ Telegram.

### –û—à–∏–±–∫–∞: "The 'afe' variable is not set"

**–ü—Ä–∏—á–∏–Ω–∞**: –ü–∞—Ä–æ–ª—å `Inf@$afe` —Å–æ–¥–µ—Ä–∂–∏—Ç `$afe`, –∫–æ—Ç–æ—Ä—ã–π Docker –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é.

**–†–µ—à–µ–Ω–∏–µ**:
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL-encoding: `Inf%40%24afe`
2. –ò–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π –±–µ–∑ `$`

### –û—à–∏–±–∫–∞: "dependency failed to start: container uk-postgres is unhealthy"

**–ü—Ä–∏—á–∏–Ω–∞**: PostgreSQL –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –∏–ª–∏ healthcheck –ø–∞–¥–∞–µ—Ç.

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ PostgreSQL
docker logs uk-postgres

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–∞—Ä–æ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç
grep POSTGRES_PASSWORD .env
grep DATABASE_URL .env

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
make clean
make start
```

### –û—à–∏–±–∫–∞: "permission denied while trying to connect to the Docker daemon"

**–ü—Ä–∏—á–∏–Ω–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ –≥—Ä—É–ø–ø–µ docker.

**–†–µ—à–µ–Ω–∏–µ**:
```bash
sudo usermod -aG docker $USER
# –ü–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è!
exit
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ .env —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker exec uk-bot env | grep DATABASE_URL
docker exec uk-postgres env | grep POSTGRES_PASSWORD
```

## üõ°Ô∏è Security –¥–ª—è Production

### 1. –ò–∑–º–µ–Ω–∏—Ç–µ –≤—Å–µ –ø–∞—Ä–æ–ª–∏

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è
openssl rand -base64 32

# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–æ–ª—å –ë–ï–ó —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
# –ù–∞–ø—Ä–∏–º–µ—Ä: a8Kf9mN2pQ4rT6vX8yZ1bC3dE5fG7hJ9
```

### 2. –ó–∞–∫—Ä–æ–π—Ç–µ –ø–æ—Ä—Ç—ã –ë–î

```bash
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ docker-compose.unified.yml
nano docker-compose.unified.yml

# –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å–µ–∫—Ü–∏–∏:
# postgres:
#   ports:
#     - "5432:5432"  # <-- –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
#
# redis:
#   ports:
#     - "6379:6379"  # <-- –ò —ç—Ç—É
```

### 3. –ò–∑–º–µ–Ω–∏—Ç–µ LOG_LEVEL –Ω–∞ INFO

```bash
# –í .env —Ñ–∞–π–ª–µ
LOG_LEVEL=INFO
DEBUG=false
```

## üìã Makefile –∫–æ–º–∞–Ω–¥—ã

```bash
make start          # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
make stop           # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
make restart        # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
make logs           # –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
make logs-bot       # –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ —Ç–æ–ª—å–∫–æ –±–æ—Ç–∞
make ps             # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
make health         # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤
make clean          # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
make rebuild        # –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
make backup-db      # –°–æ–∑–¥–∞—Ç—å backup –ë–î
```

## üéØ Checklist –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É docker
- [ ] –°–æ–∑–¥–∞–Ω .env —Ñ–∞–π–ª –∏–∑ .env.unified.example
- [ ] BOT_TOKEN —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç, –ø–æ–ª—É—á–µ–Ω —É @BotFather)
- [ ] MEDIA_BOT_TOKEN —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–º–µ–¥–∏–∞ –±–æ—Ç, –ø–æ–ª—É—á–µ–Ω —É @BotFather)
- [ ] POSTGRES_PASSWORD —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–ë–ï–ó —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤)
- [ ] DATABASE_URL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ –ø–∞—Ä–æ–ª—å
- [ ] `make start` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –í—Å–µ 5 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∑–∞–ø—É—â–µ–Ω—ã (`docker ps`)
- [ ] Healthcheck –ø—Ä–æ—Ö–æ–¥–∏—Ç (`make health`)
- [ ] –û–±–∞ –±–æ—Ç–∞ –æ—Ç–≤–µ—á–∞—é—Ç –≤ Telegram

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞

```bash
cd ~/Infrasafe_bot
git pull
make restart
```

## üìû –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç

1. –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞:
```bash
make clean
docker system prune -a --volumes  # –í–ù–ò–ú–ê–ù–ò–ï: —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ!
make start
```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞:
```bash
docker logs uk-postgres
docker logs uk-redis
docker logs uk-bot
docker logs uk-media-service
docker logs uk-media-frontend
```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ .env —Ñ–∞–π–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π:
```bash
cat .env | grep -v "^#" | grep -v "^$"
```

---

**–°–æ–∑–¥–∞–Ω–æ**: 15 –æ–∫—Ç—è–±—Ä—è 2025
**–í–µ—Ä—Å–∏—è**: 1.0
**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π**: https://github.com/a-afanasyev/Infrasafe_bot
