# UK Management Bot

Telegram‑бот для управляющей компании: сервис‑деск с ролями, заявками, сменами и уведомлениями. Разработан на Python (Aiogram 3, SQLAlchemy), ориентирован на простую локальную разработку и покрыт автотестами.

## Ключевые возможности

- Роли и доступы (RBAC):
  - **Житель (заявитель)**: создаёт и просматривает свои заявки, получает уведомления
  - **Сотрудник (исполнитель)**: работает с назначенными заявками в рамках активной смены
  - **Менеджер**: назначение/модерация, управление сменами и заявками
- Система заявок:
  - Категории, срочность, адрес, описание, медиа, статусы и история
  - Просмотр, фильтры, пагинация, действия по заявке
- Система смен:
  - Старт/сдача смены, история, статистика, ограничения действий вне смены
  - Уведомления о начале/завершении смены (пользователю и в канал)
- Уведомления по заявкам:
  - Стандартизированные сообщения для заявителя, исполнителя и канала
- Локализация: ru/uz
- Тесты: компонентные и интеграционные (pytest)

## Архитектура и стек

- **Python 3.11+**, **Aiogram 3.x** (Telegram Bot API)
- **SQLAlchemy** (ORM), **SQLite** (по умолчанию для разработки)
- Локализация через JSON (`uk_management_bot/config/locales/*.json`)
- Логирование и аудит ключевых действий

Структура (сокращённо):

```
uk_management_bot/
  admin/           # админ/менеджер функции
  handlers/        # обработчики бота (заявки, смены, авторизация, пр.)
  keyboards/       # клавиатуры (Reply/Inline)
  services/        # бизнес-логика (requests, shifts, notifications, auth)
  database/        # модели, сессии, миграции
  middlewares/     # middleware (auth, shift, localization, logging)
  utils/           # утилиты, константы, валидаторы
  config/          # настройки и локализации
  main.py          # точка входа бота
```

## Быстрый старт (локально)

1) Установите Python 3.11+ и создайте виртуальное окружение

```bash
python3 -m venv .venv
source .venv/bin/activate  # macOS/Linux
# .venv\Scripts\activate  # Windows PowerShell
```

2) Установите зависимости

```bash
pip install -r requirements.txt
pip install -r uk_management_bot/requirements.txt
```

3) Настройте переменные окружения (пример)

```bash
export BOT_TOKEN="<TELEGRAM_BOT_TOKEN>"
export TELEGRAM_CHANNEL_ID=""         # необязательно
export ADMIN_USER_IDS="123456789,987654321"  # через запятую
export LOG_LEVEL="INFO"
```

4) Инициализируйте БД и запустите бота

```bash
python -m uk_management_bot.main
# либо
python uk_management_bot/main.py
```

По умолчанию используется SQLite. Конфигурация задаётся в `uk_management_bot/config/settings.py`.

## Тесты

```bash
pytest -q
```

Основные тесты находятся в корне проекта (`test_*.py`).

## Много‑ролевой режим (Roadmap / Раздел 6)

Один Telegram‑профиль может иметь несколько ролей, при этом активен один «режим» (житель / сотрудник / менеджер). Интерфейс и доступ динамически зависят от роли и контекста смен.

- План и декомпозиция задач: см. `MemoryBank/tasks.md` (Раздел 6, Task 6.1–6.11)
- Коротко:
  - Модель/миграции для `roles`, `active_role`, `status`
  - Middleware `auth` и `role_mode`, расширение `shift`
  - Меню с переключением режимов, автопредложение при старте смены
  - Ограничения действий вне смены (исполнитель), при этом житель всегда может создавать заявки
  - Менеджерский раздел, уведомления, локализация, тесты, аудит

## Безопасность и хранение данных

- Телефон и контакт пользователя используются для верификации
- Документы (например, кадастр/договор) — через Telegram `file_id` и метаданные
- Аудит модерации и ключевых действий

## Локализация

- Русский (ru), Узбекский (uz)
- Добавление ключей: `uk_management_bot/config/locales/*.json`

## Планы и интеграции

- Раздел 4: Оценки и админ‑панель (планируется)
- Раздел 5: Интеграции и дашборд (Google Sheets, экспорт) — планируется
- Раздел 6: Много‑ролевой режим — в планировании/реализации

## Лицензия

Лицензия не указана. При необходимости добавьте файл LICENSE.


