# РАЗДЕЛ 6 — Много‑ролевой режим (Житель / Сотрудник / Менеджер)

## Статус
- ✅ Завершён (100%)

## Область и цели
- Поддержка множественных ролей у одного пользователя: `applicant` (житель), `executor` (сотрудник), `manager` (менеджер)
- Один активный режим в каждый момент времени (`active_role`)
- Доступы и интерфейс зависят от роли и контекста активной смены
- Создание заявок жителем доступно всегда

## План и мильстоуны
- M1: 6.1 — Схема/миграции (users.roles, users.active_role)
- M2: 6.2 — Middleware: `auth`, `role_mode`, расширение `shift`
- M3: 6.3 — Меню и переключение режима
- M4: 6.4–6.6 — Автопредложение и ограничения вне смены; доступность подачи заявок
- M5: 6.7–6.9 — Менеджерский режим, уведомления, локализация
- M6: 6.10–6.11 — Тесты и аудит/безопасность

## Реализация по задачам (REFLECT)
- 6.1 — Схема/миграции
  - Добавлены поля `roles` (TEXT JSON) и `active_role` (VARCHAR) в `users`
  - Совместимость: сохранено историческое поле `role`; миграция с безопасным бекфиллом
- 6.2 — RBAC и режимы (middleware)
  - `auth_middleware`: загрузка пользователя, статусы `pending/approved/blocked`
  - `role_mode_middleware`: нормализация `roles`/`active_role`, дефолты, fail‑safe
  - Интеграция порядка: `db → auth → role_mode → shift`
- 6.3 — Меню и переключение режима
  - Динамическое главное меню по роли; inline‑переключатель `switch_role:<role>`
  - `AuthService.set_active_role(...)` с валидацией по `roles`
- 6.4 — Автопредложение при старте смены
  - После `start_shift` предложение перейти в `executor`, если роль есть, но не активна
  - Inline‑кнопки: перейти / остаться; локализованные тексты
- 6.5 — Ограничения для исполнителя вне смены
  - Централизованный барьер в `RequestService.update_status_by_actor` через `ShiftService.is_user_in_active_shift`
  - Просмотр разрешён, изменение статусов — только в активной смене
- 6.6 — Создание заявок всегда доступно
  - Доступно в любом режиме и вне смены; локализованный хинт в `handlers/requests.py`
- 6.7 — Менеджерский режим
  - Админ‑хэндлеры защищены RBAC (роль `manager`), локализованные отказы
- 6.8 — Уведомления
  - Шаблоны для смены режима и отказов; best‑effort отправка, без дублей
- 6.9 — Локализация (RU/UZ)
  - Выровнены ключи, добавлены недостающие, исправлены битые символы; фолбэк на RU
- 6.10 — Тесты и итоговая проверка
  - Добавлены тесты локализации/уведомлений/role_mode; зелёные без регрессий
- 6.11 — Аудит и безопасность
  - In‑memory rate‑limit (10 сек) на смену роли; запись `AuditLog(action="role_switched", details={old_role,new_role})`

## Тест‑план и результаты
- Юнит: парсинг/сохранение `roles`/`active_role`, middleware дефолты/статусы, билдеры уведомлений, локализация
- Интеграция: переключение режимов, автопредложение, ограничения вне смены, создание заявки в любых режимах
- Результаты: все тесты по Разделу 6 зелёные; регрессий по Разделам 2–3 нет

## DoD (критерии приёмки)
- Контекст `user/roles/active_role/shift_context` доступен во всех апдейтах, fail‑safe
- Переключение режима отражается в UI мгновенно; менеджерский раздел доступен только менеджеру
- Ограничения исполнителя вне смены соблюдаются; создание заявок всегда доступно
- Сообщения и хинты локализованы; уведомления без дублей
- Аудит переключений и rate‑limit работают

## Артефакты
- `uk_management_bot/middlewares/auth.py`, `uk_management_bot/middlewares/shift.py`
- `uk_management_bot/handlers/base.py`, `uk_management_bot/handlers/requests.py`, `uk_management_bot/handlers/shifts.py`
- `uk_management_bot/keyboards/base.py`
- `uk_management_bot/services/auth_service.py`, `uk_management_bot/services/notification_service.py`, `uk_management_bot/services/shift_service.py`, `uk_management_bot/services/request_service.py`
- `uk_management_bot/config/locales/ru.json`, `uk_management_bot/config/locales/uz.json`
- Тесты: `test_role_mode_middleware.py`, `test_notifications.py`, `test_helpers_get_text.py`, `test_auth_service_role_switch.py`


