# 📋 Система передачи заявок на исполнение

## 🎯 Обзор

Система передачи заявок на исполнение позволяет менеджерам назначать заявки группам исполнителей или конкретным исполнителям, а также управлять полным жизненным циклом заявки от назначения до принятия.

## 🏗️ Архитектура

### Основные компоненты

#### 1. **Модели базы данных**
- `Request` - расширена новыми полями для назначений и отчетов
- `RequestComment` - комментарии к заявкам с привязкой к статусам
- `RequestAssignment` - назначения заявок (групповые/индивидуальные)

#### 2. **Сервисы**
- `AssignmentService` - управление назначениями заявок
- `CommentService` - управление комментариями
- `RequestService` - расширен для работы с новыми статусами

#### 3. **Обработчики**
- `request_assignment.py` - назначение заявок
- `request_status_management.py` - управление статусами
- `request_comments.py` - управление комментариями
- `request_reports.py` - отчеты о выполнении

#### 4. **FSM состояния**
- `request_assignment.py` - состояния для назначений
- `request_status.py` - состояния для управления статусами
- `request_comments.py` - состояния для комментариев
- `request_reports.py` - состояния для отчетов

#### 5. **Клавиатуры**
- `request_assignment.py` - клавиатуры для назначений
- `request_status.py` - клавиатуры для статусов
- `request_comments.py` - клавиатуры для комментариев
- `request_reports.py` - клавиатуры для отчетов

## 🔄 Жизненный цикл заявки

### 1. **Назначение заявки**
```
Новая заявка → Назначение группе/исполнителю → Статус "В работе"
```

**Варианты назначения:**
- **Групповое назначение**: заявка назначается группе исполнителей с определенной специализацией
- **Индивидуальное назначение**: заявка назначается конкретному исполнителю

### 2. **Управление статусами**
```
В работе → Закуп → В работе → Уточнение → В работе → Исполнено → Принято
```

**Доступные статусы:**
- **"Новая"** - заявка создана, ожидает назначения
- **"В работе"** - заявка назначена и выполняется
- **"Закуп"** - исполнитель запрашивает материалы
- **"Уточнение"** - требуется дополнительная информация
- **"Исполнено"** - работа завершена, ожидает принятия
- **"Принято"** - заявка принята заявителем (финальный статус)

### 3. **Система комментариев**
Каждое изменение статуса может сопровождаться комментарием:

**Типы комментариев:**
- **Уточнение** - дополнительная информация по заявке
- **Закупка материалов** - список необходимых материалов
- **Отчет о выполнении** - детальный отчет о проделанной работе
- **Общий комментарий** - произвольный комментарий

## 👥 Роли пользователей

### **Менеджер**
- Назначает заявки группам или конкретным исполнителям
- Изменяет статусы заявок
- Просматривает все заявки и отчеты
- Управляет процессом выполнения

### **Исполнитель**
- Видит назначенные заявки в "Мои заявки"
- Изменяет статусы заявок
- Добавляет комментарии о материалах и ходе работы
- Создает отчеты о выполнении

### **Заявитель**
- Просматривает свои заявки
- Принимает выполненные заявки
- Запрашивает доработку при необходимости
- Просматривает комментарии и отчеты

## 🛠️ Технические детали

### **Константы системы**

```python
# Типы назначений
ASSIGNMENT_TYPE_GROUP = "group"
ASSIGNMENT_TYPE_INDIVIDUAL = "individual"

# Статусы назначений
ASSIGNMENT_STATUS_ACTIVE = "active"
ASSIGNMENT_STATUS_CANCELLED = "cancelled"
ASSIGNMENT_STATUS_COMPLETED = "completed"

# Типы комментариев
COMMENT_TYPE_STATUS_CHANGE = "status_change"
COMMENT_TYPE_CLARIFICATION = "clarification"
COMMENT_TYPE_PURCHASE = "purchase"
COMMENT_TYPE_REPORT = "report"

# Статусы заявок
REQUEST_STATUS_APPROVED = "Принято"
```

### **Основные методы сервисов**

#### AssignmentService
```python
def assign_to_group(request_id: int, specialization: str, assigned_by: int) -> RequestAssignment
def assign_to_executor(request_id: int, executor_id: int, assigned_by: int) -> RequestAssignment
def get_executor_assignments(executor_id: int, status: str = "active") -> List[RequestAssignment]
def cancel_assignment(assignment_id: int, cancelled_by: int) -> bool
```

#### CommentService
```python
def add_comment(request_id: int, user_id: int, comment_text: str, comment_type: str) -> RequestComment
def get_request_comments(request_id: int, limit: int = 50) -> List[RequestComment]
def add_status_change_comment(request_id: int, user_id: int, previous_status: str, new_status: str) -> RequestComment
def format_comments_for_display(comments: List[RequestComment], language: str = "ru") -> str
```

#### RequestService
```python
def change_status(request_id: int, new_status: str, user_id: int) -> Request
def get_requests_by_status(status: str) -> List[Request]
def get_user_requests(user_id: int) -> List[Request]
```

## 📱 Пользовательский интерфейс

### **Клавиатуры для менеджеров**

#### Назначение заявки
```
📋 Назначение заявки на исполнение

👥 Назначить группе исполнителей
👤 Назначить конкретному исполнителю
❌ Отмена
```

#### Выбор специализации
```
Выберите специализацию:

🔌 Электрик
🔧 Сантехник
🔥 Отопление
🌬️ Вентиляция
📺 Лифт
🧹 Уборка
🌳 Благоустройство
🛡️ Безопасность
🌐 Интернет/ТВ
📋 Другое
```

#### Выбор исполнителя
```
Выберите исполнителя:

👤 Иванов Иван (Сантехник)
👤 Петров Петр (Сантехник)
👤 Сидоров Сидор (Сантехник)
```

### **Клавиатуры для исполнителей**

#### Управление статусами
```
📊 Управление статусом заявки

🛠️ Взять в работу
🛒 Закупка материалов
✅ Завершить работу
❓ Уточнение
```

#### Комментарии
```
💬 Управление комментариями

❓ Уточнение
🛒 Закупка материалов
📋 Отчет о выполнении
💬 Общий комментарий
```

### **Клавиатуры для заявителей**

#### Принятие заявки
```
📋 Отчет о выполнении заявки #123

👍 Принять заявку
🔧 Запросить доработку
📝 Добавить комментарий
📋 Просмотр комментариев
🔙 Назад к заявке
```

## 🔒 Безопасность и права доступа

### **Проверки прав доступа**

1. **Назначение заявок**: только менеджеры
2. **Изменение статусов**: менеджеры и исполнители (в зависимости от статуса)
3. **Добавление комментариев**: все участники заявки
4. **Принятие заявок**: только заявитель
5. **Просмотр отчетов**: все участники заявки

### **Валидация данных**

- Проверка существования заявки
- Проверка прав пользователя
- Валидация переходов статусов
- Проверка обязательных комментариев

## 📊 Тестирование

### **Созданные тесты**

1. **`test_request_assignment_system.py`** - модульные тесты всех компонентов
2. **`test_integration_full_cycle.py`** - интеграционные тесты полного цикла

### **Покрытие тестами**

- ✅ Сервисы (AssignmentService, CommentService, RequestService)
- ✅ Обработка ошибок
- ✅ Интеграционные сценарии
- ✅ Производительность
- ✅ Целостность данных

### **Запуск тестов**

```bash
# Запуск всех тестов системы
pytest tests/test_request_assignment_system.py -v

# Запуск интеграционных тестов
pytest tests/test_integration_full_cycle.py -v

# Запуск с покрытием
pytest tests/ --cov=uk_management_bot --cov-report=html
```

## 🌐 Локализация

### **Добавленные ключи локализации**

```json
{
  "request_assignment": {
    "title": "📋 Назначение заявки на исполнение",
    "select_type": "Выберите тип назначения:",
    "group_assignment": "👥 Назначить группе исполнителей",
    "individual_assignment": "👤 Назначить конкретному исполнителю"
  },
  "request_status": {
    "title": "📊 Управление статусом заявки",
    "select_status": "Выберите новый статус:",
    "status_changed": "✅ Статус заявки изменен"
  },
  "comments": {
    "title": "💬 Управление комментариями",
    "select_type": "Выберите тип комментария:",
    "add_comment": "📝 Добавить комментарий"
  },
  "reports": {
    "title": "📋 Отчеты о выполнении",
    "view_report": "📊 Просмотр отчета",
    "approve_request": "👍 Принять заявку"
  }
}
```

## 🚀 Развертывание

### **Миграции базы данных**

```bash
# Применение миграций
python -m uk_management_bot.database.migrations.add_request_assignment_fields
```

### **Проверка работоспособности**

1. **Проверка контейнеров**:
   ```bash
   docker ps
   ```

2. **Проверка логов**:
   ```bash
   docker logs uk-management-bot-dev
   ```

3. **Запуск тестов**:
   ```bash
   pytest tests/test_request_assignment_system.py -v
   ```

## 📈 Мониторинг

### **Ключевые метрики**

- Количество назначенных заявок
- Время выполнения заявок
- Количество комментариев
- Статистика по статусам
- Производительность системы

### **Логирование**

Все операции логируются с указанием:
- Пользователя, выполнившего действие
- Времени выполнения
- Типа операции
- Результата выполнения

## 🔧 Обслуживание

### **Регулярные задачи**

1. **Очистка старых комментариев** (если необходимо)
2. **Архивирование завершенных заявок**
3. **Мониторинг производительности**
4. **Обновление локализации**

### **Резервное копирование**

Рекомендуется регулярное резервное копирование:
- База данных PostgreSQL
- Файлы конфигурации
- Логи системы

## 📞 Поддержка

### **Известные проблемы**

1. **Нет проблем** - система работает стабильно

### **Планы развития**

1. **Уведомления** - система уведомлений о изменениях
2. **Аналитика** - детальная аналитика по заявкам
3. **Мобильное приложение** - расширение функциональности
4. **Интеграции** - интеграция с внешними системами

---

**Версия документа**: 1.0  
**Дата создания**: 25 августа 2025  
**Автор**: Система разработки  
**Статус**: Актуально
