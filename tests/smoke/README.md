# Smoke Tests for UK Management Bot Microservices

This directory contains comprehensive smoke tests for verifying the integration between microservices in the UK Management Bot system.

## Overview

The smoke tests verify critical functionality across three main services:
- **Auth Service** (port 8000) - JWT authentication and service tokens
- **User Service** (port 8001) - User management and profiles
- **Media Service** (port 8080) - File upload and storage

## Test Suites

### 1. Auth-User Integration Tests (`test_auth_user_integration.py`)
Tests service-to-service authentication and communication:
- âœ… Service connectivity and health checks
- âœ… Service token generation and validation
- âœ… Auth Service calling User Service APIs
- âœ… Login flow simulation
- âœ… User statistics integration
- âœ… Error handling and fallback mechanisms

### 2. User CRUD Tests (`test_user_crud.py`)
Tests user management operations:
- âœ… User creation, retrieval, update
- âœ… User lookup by ID and Telegram ID
- âœ… Role management
- âœ… User listing with pagination
- âœ… Duplicate prevention
- âœ… Error handling for non-existent users

### 3. Media Upload Tests (`test_media_upload.py`)
Tests file upload and storage functionality:
- âœ… Standard file upload
- âœ… Streaming file upload (for large files)
- âœ… Multiple file upload
- âœ… File retrieval and download
- âœ… File search by request number
- âœ… Upload progress tracking
- âœ… File validation and authentication

## Running the Tests

### Prerequisites

1. **Start all services** using Docker Compose:
   ```bash
   cd /path/to/microservices
   docker-compose up -d
   ```

2. **Verify services are running**:
   ```bash
   # Check Auth Service
   curl http://localhost:8000/health

   # Check User Service
   curl http://localhost:8001/health

   # Check Media Service
   curl http://localhost:8080/health
   ```

### Run All Smoke Tests

```bash
# Run complete test suite
cd tests/smoke
python run_all_smoke_tests.py
```

### Run Individual Test Suites

```bash
# Auth-User integration only
python test_auth_user_integration.py

# User CRUD operations only
python test_user_crud.py

# Media upload operations only
python test_media_upload.py
```

### Using pytest (optional)

```bash
# Install pytest if needed
pip install pytest pytest-asyncio

# Run with pytest
pytest test_auth_user_integration.py -v
pytest test_user_crud.py -v
pytest test_media_upload.py -v
```

## Test Configuration

### Service URLs
- Auth Service: `http://localhost:8000`
- User Service: `http://localhost:8001`
- Media Service: `http://localhost:8080`

### Authentication
Tests use both JWT service tokens and API key fallbacks:
- **Service Tokens**: Generated by Auth Service for inter-service calls
- **API Keys**: Simple format `service-name.hash` for development

### Test Data
Tests create temporary users and files that are automatically cleaned up:
- Test users with telegram_ids: 999999999, 111111111, 222222222
- Test files: Small JPEG, PDF, and text files
- Test request numbers: 250926-001, 250926-002, etc.

## Expected Results

### Healthy System
```
ğŸ§ª UK MANAGEMENT BOT - COMPREHENSIVE SMOKE TESTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Auth Service is available and healthy
âœ… User Service is available and healthy
âœ… Media Service is available and healthy

ğŸ“‹ TEST SUITE 1/3: Auth-User Service Integration
âœ… PASSED - Auth-User Service Integration (15.2s)

ğŸ“‹ TEST SUITE 2/3: User CRUD Operations
âœ… PASSED - User CRUD Operations (8.7s)

ğŸ“‹ TEST SUITE 3/3: Media Upload Operations
âœ… PASSED - Media Upload Operations (12.1s)

ğŸ“Š OVERALL SMOKE TEST RESULTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ‰ SMOKE TESTS PASSED (100% success rate)
```

### Common Issues and Solutions

#### Service Unavailable
```
âŒ Auth Service is not available: Connection refused
```
**Solution**: Ensure service is running with `docker-compose up auth-service`

#### Authentication Failures
```
âŒ Service token validation failed
```
**Solution**: Check that Auth Service can generate tokens and User Service can validate them

#### Database Connection Issues
```
âŒ Database connection failed
```
**Solution**: Verify PostgreSQL is running and services can connect

#### Port Conflicts
```
âŒ Address already in use
```
**Solution**: Check for conflicting services and adjust port configuration

## Integration with CI/CD

The smoke tests are designed to run in CI/CD pipelines:

```yaml
# Example GitHub Actions workflow
- name: Run Smoke Tests
  run: |
    docker-compose up -d
    sleep 30  # Wait for services to start
    cd tests/smoke
    python run_all_smoke_tests.py
```

## Test Coverage

The smoke tests verify:
- âœ… Service health and availability
- âœ… Inter-service authentication
- âœ… Core business logic (user management, file upload)
- âœ… Error handling and edge cases
- âœ… API contract compliance
- âœ… Data persistence and retrieval

## Troubleshooting

### Enable Debug Logging
Set environment variables for detailed logging:
```bash
export LOG_LEVEL=DEBUG
export AUTH_LOG_LEVEL=DEBUG
export USER_LOG_LEVEL=DEBUG
export MEDIA_LOG_LEVEL=DEBUG
```

### Check Service Logs
```bash
# View logs for specific service
docker-compose logs -f auth-service
docker-compose logs -f user-service
docker-compose logs -f media-service
```

### Manual API Testing
Use curl to test individual endpoints:
```bash
# Generate service token
curl -X POST http://localhost:8000/api/v1/internal/generate-service-token \
  -d "service_name=test-service"

# Test user lookup
curl -H "Authorization: Bearer <token>" \
  http://localhost:8001/api/v1/users/by-telegram/123456789
```

## Contributing

To add new smoke tests:

1. **Create test file** following the pattern `test_<feature>.py`
2. **Implement test class** with cleanup methods
3. **Add async test runner** function
4. **Update master runner** to include new test suite
5. **Update this README** with new test description

Test files should:
- Use async/await patterns
- Clean up test data automatically
- Handle service unavailability gracefully
- Provide clear success/failure reporting
- Include both positive and negative test cases