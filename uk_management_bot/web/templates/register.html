<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é - UK Management</title>
    <link rel="stylesheet" href="https://uk-management.local/static/style.css">
    <script src="/static/telegram-web-app.js"></script>
    <script>
        // –ü—Ä–æ—Å—Ç–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
            
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                console.log('Telegram Web App –Ω–∞–π–¥–µ–Ω');
                try {
                    Telegram.WebApp.ready();
                    console.log('Telegram Web App –≥–æ—Ç–æ–≤');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ Telegram Web App:', error);
                }
            } else {
                console.log('Telegram Web App –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é</h1>
            <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è UK!</p>
        </div>

        <div class="invite-info" id="inviteInfo" style="display: none;">
            <div class="info-card">
                <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–∏</h3>
                <div class="info-item">
                    <span class="label">–†–æ–ª—å:</span>
                    <span class="value" id="roleValue">-</span>
                </div>
                <div class="info-item" id="specializationInfo" style="display: none;">
                    <span class="label">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:</span>
                    <span class="value" id="specializationValue">-</span>
                </div>
                <div class="info-item">
                    <span class="label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</span>
                    <span class="value" id="expiresValue">-</span>
                </div>
            </div>
        </div>

        <div class="error-message" id="errorMessage" style="display: none;">
            <div class="error-card">
                <h3>‚ùå –û—à–∏–±–∫–∞</h3>
                <p id="errorText"></p>
            </div>
        </div>

        <form class="registration-form" id="registrationForm" style="display: none;">
            <div class="form-group">
                <label for="fullName">–§–ò–û *</label>
                <input type="text" id="fullName" name="fullName" required 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –ø–æ–ª–Ω–æ–µ –∏–º—è" 
                       pattern="[–ê-–Ø–∞-—è–Å—ë\s]{2,50}" 
                       title="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã, –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞">
                <small>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã.</small>
            </div>

            <div class="form-group" id="specializationGroup" style="display: none;">
                <label for="specialization">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è *</label>
                <select id="specialization" name="specialization" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é</option>
                </select>
                <small>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π.</small>
            </div>

            <div class="form-group">
                <label>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram</label>
                <div class="telegram-auth">
                    <button type="button" id="telegramAuthBtn" class="btn btn-telegram">
                        üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram
                    </button>
                    <div id="telegramStatus" class="telegram-status"></div>
                </div>
                <small>–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram.</small>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                    ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
                </button>
            </div>
        </form>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let inviteToken = '{{ token }}';
        let inviteData = null;
        let telegramUser = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = null;
        if (window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            console.log('Telegram Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        } else {
            console.log('Telegram Web App –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
        async function loadInviteData() {
            try {
                const response = await fetch(`/api/validate/${inviteToken}`);
                const data = await response.json();
                
                if (data.valid) {
                    inviteData = data;
                    showInviteInfo(data);
                    showRegistrationForm(data);
                } else {
                    showError(data.message || '–ù–µ–≤–µ—Ä–Ω–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ');
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–∏
        function showInviteInfo(data) {
            document.getElementById('roleValue').textContent = getRoleName(data.role);
            document.getElementById('expiresValue').textContent = formatDate(data.expires_at);
            
            if (data.specialization) {
                document.getElementById('specializationValue').textContent = data.specialization;
                document.getElementById('specializationInfo').style.display = 'block';
            }
            
            document.getElementById('inviteInfo').style.display = 'block';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        function showRegistrationForm(data) {
            if (data.role === 'executor') {
                loadSpecializations();
                document.getElementById('specializationGroup').style.display = 'block';
            }
            
            document.getElementById('registrationForm').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–π
        async function loadSpecializations() {
            try {
                const response = await fetch('/api/specializations');
                const data = await response.json();
                
                const select = document.getElementById('specialization');
                data.specializations.forEach(spec => {
                    const option = document.createElement('option');
                    option.value = spec.id;
                    option.textContent = spec.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–π:', error);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏
        function getRoleName(role) {
            const roles = {
                'applicant': '–ó–∞—è–≤–∏—Ç–µ–ª—å',
                'executor': '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å',
                'manager': '–ú–µ–Ω–µ–¥–∂–µ—Ä'
            };
            return roles[role] || role;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—É
        function formatDate(dateString) {
            if (!dateString) return '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU');
        }

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
        document.getElementById('telegramAuthBtn').addEventListener('click', function() {
            if (!tg) {
                document.getElementById('telegramStatus').innerHTML = 
                    `<div class="error">‚ùå Telegram Web App –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ Telegram.</div>`;
                return;
            }
            
            try {
                tg.showPopup({
                    title: '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
                    message: '–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram',
                    buttons: [{
                        id: 'auth',
                        type: 'default',
                        text: '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è'
                    }]
                }, function(buttonId) {
                    if (buttonId === 'auth') {
                        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram Web App
                        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                            telegramUser = tg.initDataUnsafe.user;
                            document.getElementById('telegramStatus').innerHTML = 
                                `<div class="success">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ ${telegramUser.first_name}</div>`;
                            document.getElementById('telegramAuthBtn').disabled = true;
                            document.getElementById('submitBtn').disabled = false;
                        } else {
                            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                            document.getElementById('telegramStatus').innerHTML = 
                                `<div class="info">‚ÑπÔ∏è –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ Telegram –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</div>`;
                        }
                    }
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ popup:', error);
                document.getElementById('telegramStatus').innerHTML = 
                    `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}</div>`;
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!telegramUser) {
                showError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram');
                return;
            }

            const formData = {
                token: inviteToken,
                full_name: document.getElementById('fullName').value.trim(),
                specialization: document.getElementById('specialization').value,
                telegram_id: telegramUser.id
            };

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!formData.full_name) {
                showError('–í–≤–µ–¥–∏—Ç–µ –§–ò–û');
                return;
            }

            if (inviteData.role === 'executor' && !formData.specialization) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é');
                return;
            }

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            try {
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';

                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    // –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    document.querySelector('.container').innerHTML = `
                        <div class="success-page">
                            <div class="success-card">
                                <h2>‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
                                <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É UK Management!</p>
                                <p>–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
                                <p>–û–∂–∏–¥–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –≤–∞—à–µ–π –∑–∞—è–≤–∫–∏.</p>
                                <button class="btn btn-primary" onclick="if(tg) tg.close(); else window.close();">
                                    –ó–∞–∫—Ä—ã—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    showError(result.detail || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').textContent = '‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é';
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = '‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é';
            }
        });

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadInviteData();
        });
    </script>
</body>
</html>
